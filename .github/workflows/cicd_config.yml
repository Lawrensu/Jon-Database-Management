# A descriptive name for your workflow
name: CI with PostgreSQL Database

# Controls when the workflow will run
on:
  # Triggers on pushes or pull requests to the main branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # A single job in this workflow, named "test"
  test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Service containers to run with `test` job
    services:
      # Label used to access the service container
      postgres:
        # Docker Hub image for PostgreSQL. Use a specific version for reproducibility.
        image: postgres:18
        # Provide the password for Postgres
        env:
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-JonathanBangerDatabase26!}
          POSTGRES_USER: ${POSTGRES_USER:-jondb_admin}
          POSTGRES_DB: ${POSTGRES_DB:-jon_database_dev}
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # Map the container port to the host
        ports:
          # Maps port 5432 on the host to port 5432 on the service container
          - 5432:5432

    steps:
      # Step 1: Check out your repository code
      - name: Check out repository code
        uses: actions/checkout@v4

      # Step 2: Wait for PostgreSQL to be ready
      # This is a good practice to ensure the DB is fully initialized before running tests.
      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          while ! pg_isready -h localhost -p 5432 -U postgres_user; do
            sleep 2
          done
          echo "PostgreSQL is ready."

      # Step 3: (Example for Node.js) Install dependencies
      # Replace this with your project's dependency manager
      - name: Install Node.js dependencies
        run: npm ci

      # Step 4: Run your application tests
      # This is where you run your test suite.
      # IMPORTANT: Your application must be configured to connect to the database
      # using the environment variables or connection string details below.
      - name: Run tests
        env:
          # The hostname is 'localhost' because we mapped the port.
          # If you don't map the port, the hostname would be the service name: 'postgres'
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: ${POSTGRES_USER:-jondb_admin}
          DB_PASSWORD: ${POSTGRES_PASSWORD:-JonathanBangerDatabase26!}
          DB_NAME: ${POSTGRES_DB:-jon_database_dev}
        run: npm test
