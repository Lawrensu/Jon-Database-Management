name: CI with PostgreSQL Database + AI/DS Analytics

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: jondb_admin
          POSTGRES_PASSWORD: JonathanBangerDatabase26!
          POSTGRES_DB: jon_database_dev
          POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 --auth-host=md5"
        options: >-
          --health-cmd "pg_isready -U jondb_admin -d jon_database_dev"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3
          --health-start-period 40s
        ports:
          - 5432:5432

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL to be ready
        run: |
          while ! pg_isready -h localhost -U jondb_admin -d jon_database_dev; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done

      - name: Install PGVector
        run: |
          echo "Installing pgvector extension package inside Postgres container..."
          CID=${{ job.services.postgres.id }}
          # Update apt and install pgvector for Postgres 16 inside the service container
          docker exec "$CID" bash -lc "apt-get update && apt-get install -y postgresql-16-pgvector && rm -rf /var/lib/apt/lists/*"
          echo "Creating pgvector extension..."
          PGPASSWORD=JonathanBangerDatabase26! psql -h localhost -U jondb_admin -d jon_database_dev -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: Run database initialization scripts
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Running initialization scripts..."
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/init/01_setup.sql
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/init/02_monitor.sql
          echo "Initialization complete."

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Create database schema
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Creating database schema..."
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/project/01_core_schema.sql
          
      - name: Enable monitoring triggers
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Enabling monitoring triggers..."
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/project/02_monitoring_triggers.sql

      - name: Run database seeds
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Running database seeds..."
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/seeds/00_reference_data.sql
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/seeds/01_patients_seed.sql
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/seeds/02_doctors_seed.sql
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/seeds/03_admins_seed.sql
          echo "Core seeds loaded (prescriptions skipped for CI speed)."

      - name: Install AI Enhancement (Jonathan)
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: jondb_admin
          POSTGRES_PASSWORD: JonathanBangerDatabase26!
          POSTGRES_DB: jon_database_dev
        run: |
          echo "Installing AI enhancement..."
          node scripts/install-ai.js

      - name: Generate Synthetic Embeddings
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: jondb_admin
          POSTGRES_PASSWORD: JonathanBangerDatabase26!
          POSTGRES_DB: jon_database_dev
          NUM_INSERTS: 50
        run: |
          echo "Generating 50 synthetic embeddings..."
          node scripts/generate_synthetic_data.js

      - name: Install Data Science Analytics (Cherylynn)
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Installing Data Science analytics views..."
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/analytics/00_install_all.sql
        
      - name: Verify Analytics Installation
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          echo "Verifying analytics views..."
          psql -h localhost -U jondb_admin -d jon_database_dev -c "SELECT schemaname, viewname FROM pg_views WHERE schemaname = 'analytics' ORDER BY viewname;"

      - name: Test AI Semantic Search
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: jondb_admin
          POSTGRES_PASSWORD: JonathanBangerDatabase26!
          POSTGRES_DB: jon_database_dev
        run: |
          echo "Testing AI semantic search..."
          node scripts/patient_suggestion_service.js 1 "chest pain shortness of breath"
        continue-on-error: true

      - name: Run database tests
        env:
          PGPASSWORD: JonathanBangerDatabase26!
        run: |
          psql -h localhost -U jondb_admin -d jon_database_dev -f ./database/tests/run_all_tests_with_reporting.sql